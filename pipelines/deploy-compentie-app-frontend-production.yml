  resources:
  - repo: self
  
  variables:
    dockerRegistryServiceConnection: 'Container registry connection'
    imageRepository: 'competentie-app-frontend'
    containerRegistry: 'hsleidenmdlo.azurecr.io'
    vmImageName: 'ubuntu-latest'

- stage: Deploy
    displayName: Deploy stage
    dependsOn: Build
    jobs:
    - deployment: Deploy
    displayName: Deploy
    condition: eq(variables['build.sourcebranch'], 'refs/heads/master')
    pool:
        vmImage: $(vmImageName)
    environment: 'MDLO.production'
    strategy:
        runOnce:
        deploy:
            steps:
            - task: KubernetesManifest@0
            displayName: Create imagePullSecret
            inputs:
                action: 'createSecret'
                kubernetesServiceConnection: 'MDLO-mdlo-staging-1591281470325'
                namespace: 'production'
                secretType: 'dockerRegistry'
                secretName: '$(imagePullSecret)'
                dockerRegistryEndpoint: '$(dockerRegistryServiceConnection)'

            - task: KubernetesManifest@0
            displayName: Deploy to Kubernetes cluster
            inputs:
                action: 'deploy'
                kubernetesServiceConnection: 'MDLO-mdlo-staging-1591281470325'
                namespace: 'production'
                manifests: 'manifests/production/competentie-app-frontend.yml'
                containers: '$(containerRegistry)/$(imageRepository):$(tag)'
                imagePullSecrets: '$(imagePullSecret)'